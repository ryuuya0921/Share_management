<h2><%= @plaza_post.title %></h2>
<p><%= @plaza_post.content %></p>
<p>投稿者: <%= @plaza_post.user.name %> | <%= l(@plaza_post.created_at, format: :long) %></p>
<% if @plaza_post.user == current_user %>
  <%= link_to '編集', edit_plaza_post_path(@plaza_post), class: 'btn btn-primary' %>
  <%= link_to '削除', plaza_post_path(@plaza_post), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'btn btn-danger' %>
<% end %>

<h3>コメント一覧</h3>
<ul>
  <% page_number = (params[:page] || 1).to_i %>
  <% @comments.each_with_index do |comment, index| %>
    <li>
      <strong>
        <%= (page_number - 1) * 10 + index + 1 %> 名前：<%= comment.user.name %> <%= l(comment.created_at, format: :short) %>
      </strong>

      <!-- コメント表示部分 -->
      <div id="comment-display-<%= comment.id %>">
        <p><%= comment.content %></p>
        <% if comment.user == current_user %>
          <%= link_to '編集', '#', class: 'btn btn-primary btn-sm', onclick: "toggleEditForm(#{comment.id}); return false;" %>
          <%= link_to '削除', plaza_post_comment_path(@plaza_post, comment), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'btn btn-danger btn-sm' %>
        <% end %>
      </div>

      <!-- コメントのいいね機能 -->
      <div>
        <p>いいね数: <%= comment.votes_for.size %></p>
        <% unless comment.user == current_user %>
          <% if current_user.voted_for?(comment) %>
            <%= button_to 'いいねを取り消す', unlike_plaza_post_comment_path(@plaza_post, comment), method: :delete, class: 'btn btn-danger btn-sm' %>
          <% else %>
            <%= button_to 'いいね', like_plaza_post_comment_path(@plaza_post, comment), method: :post, class: 'btn btn-primary btn-sm' %>
          <% end %>
        <% end %>
      </div>

      <!-- インライン編集フォーム (デフォルトは非表示) -->
      <div id="comment-edit-form-<%= comment.id %>" style="display: none;">
        <%= form_with(model: [@plaza_post, comment], local: true, method: :patch) do |form| %>
          <div>
            <%= form.text_area :content, value: comment.content %>
          </div>
          <%= form.submit '更新', class: 'btn btn-primary btn-sm' %>
          <%= link_to 'キャンセル', '#', class: 'btn btn-secondary btn-sm', onclick: "toggleEditForm(#{comment.id}); return false;" %>
        <% end %>
      </div>
    </li>
  <% end %>
</ul>

<%= paginate @comments %>

<%= form_with(model: [@plaza_post, Comment.new], local: true) do |form| %>
  <div>
    <%= form.label :content, 'コメント内容' %><br>
    <%= form.text_area :content %>
  </div>
  <%= form.submit 'コメントを投稿', class: 'btn btn-primary' %>
<% end %>
<p><%= link_to 'みんなの広場に戻る', plaza_posts_path, class: 'btn' %></p>
